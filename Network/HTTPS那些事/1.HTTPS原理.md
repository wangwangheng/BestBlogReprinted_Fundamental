# HTTPS那些事（一）HTTPS原理

来源:[果壳网](http://www.guokr.com/post/114121/)

[wifi-secure]:http://www.guokr.com/article/100110/
[https-certificate]:2.SSL证书.md
[https-secure-example]:3.攻击实例与防御.md
[TLS-history-wiki]:http://en.wikipedia.org/wiki/Transport_Layer_Security
[google-domain-https]:http://thenextweb.com/google/2012/03/05/google-calls-for-a-more-secure-web-expands-ssl-encryption-to-local-domains/
[TLS-1.0-bug]:http://www.theregister.co.uk/2011/09/19/beast_exploits_paypal_ssl/
[TLS-1.0-bug-fixed]:http://support.microsoft.com/kb/2643584/en-us https://src.chromium.org/viewvc/chrome?view=rev&revision=90643

## 楔子

谣言粉碎机前些日子发布的[《用公共WiFi上网会危害银行账户安全吗？》][wifi-secure]，文中介绍了在使用HTTPS进行网络加密传输的一些情况，从回复来看，争议还是有的。随着网络越来越普及，应用越来越广泛，一些网络安全问题也会越来越引起网民的关注，在这里和大家一起聊聊TLS/SSL也就是我们常说的HTTPS，从原理到实际应用看清它到底是怎么一回事，以及在使用HTTPS要注意哪些问题以及相关的安全技巧。

网络安全是一个整体的事件，涉及到个人计算机的安全，协议的安全，传输数据的安全，以及软件开发公司和网站的安全，单纯的依靠一个HTTPS协议并不能解决所有的问题。希望通过今后一点一点的对安全相关的问题进行说明解释，能让更多人对网络安全有所了解，从而更安全的使用网络。

文章会比较长，暂时计划分成三个部分：

* 第一部分主要描述HTTPS的原理；
* 第二部分主要描述SSL证书验证的过程与使用的一些注意事项；
* 第三部分会呈现一些针对HTTPS攻击的实例。
* 如果有需要，我会后续的补充一些内容。

我尽量使用最简洁的语言来描述相关的概念，这里开始先挖个坑，然后慢慢地填。

* [HTTPS那些事（二）SSL证书][https-certificate]
* [HTTPS那些事（三）攻击实例与防御][https-secure-example]

## 一、什么是HTTPS

在说HTTPS之前先说说什么是HTTP，HTTP就是我们平时浏览网页时候使用的一种协议。HTTP协议传输的数据都是未加密的，也就是明文的，因此使用HTTP协议传输隐私信息非常不安全。为了保证这些隐私数据能加密传输，于是网景公司设计了**SSL（Secure Sockets Layer）**协议用于对HTTP协议传输的数据进行加密，从而就诞生了HTTPS。SSL目前的版本是3.0，被**IETF（Internet Engineering Task Force）**定义在**RFC 6101**中，之后IETF对**SSL 3.0**进行了升级，于是出现了**TLS（Transport Layer Security） 1.0**，定义在RFC 2246。实际上我们现在的HTTPS都是用的TLS协议，但是由于SSL出现的时间比较早，并且依旧被现在浏览器所支持，因此SSL依然是HTTPS的代名词，但无论是TLS还是SSL都是上个世纪的事情，SSL最后一个版本是3.0，今后TLS将会继承SSL优良血统继续为我们进行加密服务。目前TLS的版本是1.2，定义在RFC 5246中，暂时还没有被广泛的使用。

对历史感兴趣的朋友可以参考[维基百科][TLS-history-wiki]，这里有对TLS/SSL详尽的叙述。

## 二、HTTPS到底安全吗？
这个答案是肯定的，很安全。谷歌公司已经行动起来要大力推广HTTPS的使用，在未来几周，谷歌将对全球所有本地域名都启用HTTPS，用户只要在搜索前用Google帐号登录，之后所有的搜索操作都将使用TLS协议加密，见：[这里][google-domain-https]。

## 三、HTTPS的工作原理
HTTPS在传输数据之前需要客户端（浏览器）与服务端（网站）之间进行一次握手，在握手过程中将确立双方加密传输数据的密码信息。TLS/SSL协议不仅仅是一套加密传输的协议，更是一件经过艺术家精心设计的艺术品，TLS/SSL中使用了非对称加密，对称加密以及HASH算法。握手过程的简单描述如下：

* 1.浏览器将自己支持的一套加密规则发送给网站。
* 2.网站从中选出一组加密算法与HASH算法，并将自己的身份信息以证书的形式发回给浏览器。证书里面包含了网站地址，加密公钥，以及证书的颁发机构等信息。
* 3.获得网站证书之后浏览器要做以下工作：
   * a) 验证证书的合法性（颁发证书的机构是否合法，证书中包含的网站地址是否与正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示一个小锁头，否则会给出证书不受信的提示。
   * b) 如果证书受信任，或者是用户接受了不受信的证书，浏览器会生成一串随机数的密码，并用证书中提供的公钥加密。
   * c) 使用约定好的HASH计算握手消息，并使用生成的随机数对消息进行加密，最后将之前生成的所有信息发送给网站。
* 4.网站接收浏览器发来的数据之后要做以下的操作：
   * a) 使用自己的私钥将信息解密取出密码，使用密码解密浏览器发来的握手消息，并验证HASH是否与浏览器发来的一致。
   * b) 使用密码加密一段握手消息，发送给浏览器。
* 5.浏览器解密并计算握手消息的HASH，如果与服务端发来的HASH一致，此时握手过程结束，之后所有的通信数据将由之前浏览器生成的随机密码并利用对称加密算法进行加密。

这里浏览器与网站互相发送加密的握手消息并验证，目的是为了保证双方都获得了一致的密码，并且可以正常的加密解密数据，为后续真正数据的传输做一次测试。另外，HTTPS一般使用的加密与HASH算法如下：

* 非对称加密算法：RSA，DSA/DSS
* 对称加密算法：AES，RC4，3DES
* HASH算法：MD5，SHA1，SHA256

其中非对称加密算法用于在握手过程中加密生成的密码，对称加密算法用于对真正传输的数据进行加密，而HASH算法用于验证数据的完整性。由于浏览器生成的密码是整个数据加密的关键，因此在传输的时候使用了非对称加密算法对其加密。非对称加密算法会生成公钥和私钥，公钥只能用于加密数据，因此可以随意传输，而网站的私钥用于对数据进行解密，所以网站都会非常小心的保管自己的私钥，防止泄漏。

TLS握手过程中如果有任何错误，都会使加密连接断开，从而阻止了隐私信息的传输。正是由于HTTPS非常的安全，攻击者无法从中找到下手的地方，于是更多的是采用了假证书的手法来欺骗客户端，从而获取明文的信息，但是这些手段都可以被识别出来，我将在后续的文章进行讲述。不过2010年还是有安全专家发现了[TLS 1.0协议处理的一个漏洞][TLS-1.0-bug]，实际上这种称为BEAST的攻击方式早在2002年就已经被安全专家发现，只是没有公开而已。目前[微软和Google已经对此漏洞进行了修复][TLS-1.0-bug-fixed]。
